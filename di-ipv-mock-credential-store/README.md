# ID Reuse - Mock Authorisation Environment

## Introduction
A mock environment to simulate the authoriser provider by creating tokens and multiple `/.well-known/jwks.json` endpoint to verifying the tokens.

## How To
### Prerequisites
- [SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html#install-sam-cli-instructions)

### Clone the repo and switch to mock-environment
```shell
git clone git@github.com:govuk-one-login/ipv-stubs.git
cd ipv-stubs/ipv-mock-credential-store
```

### Install Project Dependencies
```shell
npm ci
```

### Build & Deploy Project
```shell
sam build -t src/infra/template.yaml --parallel
```

### Updating SSM with signing key pairs
When deploying to a new stack / environment, the key pairs for the EC and RSA signing keys will need to be updated in SSM.
Here are the instructions on how to do this:

1. Generate the key pairs:

EC key pairs:
```bash
openssl ecparam -genkey -name prime256v1 -noout -out ec-key-pair.pem
openssl ec -in ec-key-pair.pem -pubout -out ec-public.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in ec-key-pair.pem -out ec-private.key
openssl ecparam -genkey -name prime256v1 -noout -out ec-key-pair-auth.pem
openssl ec -in ec-key-pair-auth.pem -pubout -out ec-public-auth.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in ec-key-pair-auth.pem -out ec-private-auth.key
```
This will create 6 files, `ec-public.crt` contains the RSA public key,`ec-private.key` contains the RSA private key,
`ec-public-auth.crt` contains the RSA public key, and `ec-private-auth.key` contains the RSA private key.

RSA key pairs:
```bash
openssl genrsa -out rsa-key-pair.pem 2048
openssl rsa -in rsa-key-pair.pem -pubout -out rsa-public.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in rsa-key-pair.pem -out rsa-private.key
openssl genrsa -out rsa-key-pair-auth.pem 2048
openssl rsa -in rsa-key-pair-auth.pem -pubout -out rsa-public-auth.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in rsa-key-pair-auth.pem -out rsa-private-auth.key
```
This will create 6 files, `rsa-public.crt` contains the RSA public key,`rsa-private.key` contains the RSA private key,
`rsa-public-auth.crt` contains the RSA public key, and `rsa-private-auth.key` contains the RSA private key.

2. Update SSM:

In the AWS console SSM parameter store, update the following parameters with the string contained in each of the files:

| parameter name                             | parameter value   |
|--------------------------------------------|-------------------|
| /{stack-name}/EcPublicKey                  | `ec-public.crt`   |
| /{stack-name}/EcPrivateKey                 | `ec-private.key`  |
| /{stack-name}/RsaPublicKey                 | `rsa-public.crt`  |
| /{stack-name}/RsaPrivateKey                | `rsa-private.key` |
| /{stack-name}/Authentication/EcPublicKey   | `ec-public-auth.crt`   |
| /{stack-name}/Authentication/EcPrivateKey  | `ec-private-auth.key`  |
| /{stack-name}/Authentication/RsaPublicKey  | `rsa-public-auth.crt`  |
| /{stack-name}/Authentication/RsaPrivateKey | `rsa-private-auth.key` |

### Generate Token
#### In AWS console:
- Go to API gateway and select the stack: `d-reuse-ipv-core-mock`
- Select the endpoint `POST /generate`
- Press `test` to generate a valid token using an EC algorithm.

See below for instructions on how to generate different a valid token with an RSA algorithm, and the full list of invalid tokens that can be generated.

### Verify Token Using Mock JWKS Endpoint
- Navigate to this link: https://jwt.davetonge.co.uk/
- Paste a token generated by the mock endpoint `POST /generate` into the section called `Enter JWT`
- In the field labelled: `Enter jwks endpoint or issuer domain`, paste the endpoint: `https://mock.credential-store.dev.account.gov.uk/.well-known/jwks.json`

This will detail the what's included in the token header and payload. It will also verify the token using the JWKS endpoint.

### Tokens that can be generated:

| Type    | Brief Description                   | Query Parameter       | Payload Body                                                        |
|---------|-------------------------------------|-----------------------|---------------------------------------------------------------------|
| valid   | EC algorithm                        | signatureType=EC      | -                                                                   |
| valid   | RSA algorithm                       | signatureType=RSA     | -                                                                   |
| valid   | modify token `exp` (in minutes)     | -                     | { "ttl": number }                                                   |
| valid   | modify token `iat` (in minutes)     | -                     | { "iat": number } - will set `iat` to number of minutes in the past |
| valid   | modify token `iss` to use Auth JWKS | tokenType=authIss     |                                                                     |
| invalid | Invalid `alg`                       | tokenType=invalidAlg  | -                                                                   |
| invalid | `alg` equal to 'none'               | tokenType=noneAlg     | -                                                                   |
| invalid | `kid` missing from header           | tokenType=missingKid  | -                                                                   |
| invalid | `kid` not included in JWKS          | tokenType=wrongKid    | -                                                                   |
| invalid | token expired                       | tokenType=expired     | -                                                                   |
| invalid | `iat` initiated in future           | tokenType=iatInFuture | -                                                                   |
| invalid | `aud` missing from payload          | -                     | { "aud": null }                                                     |
| invalid | `aud` invalid value                 | -                     | { "aud": "invalidAudience" }                                        |
| invalid | `iss` missing from payload          | -                     | { "iss": null }                                                     |
| invalid | `iss` invalid value                 | -                     | { "iss": "invalidIssuer" }                                          |

### Simulate Controlled Errors for the JWKS endpoint
In order to test VC Storage is handling authorization correctly when the JWKS endpoint is mis-functioning, the Mock JWKS endpoint can simulate controlled errors. To switch the Mock JWKS endpoint into controlled error mode, you'll need to update the appropriate environment variable(s). Here are instructions to generate each type of controlled error:
- Generating 4XX errors x% of the time:
    - Update the environment variable: `PERCENTAGE_RETURN_4XX` to a value between 0.00 - 1.00, where 0.01 is equivalent to 1%. This value represents the proportion of times a 4XX error will be returned.
- Generating 5XX errors x% of the time.
    - Update the environment variable: `PERCENTAGE_RETURN_5XX` to a value between 0.00 - 1.00, where 0.01 is equivalent to 1%. This value represents the proportion of times a 5XX error will be returned.
- Generating timeout errors x% of the time.
    - Update the environment variable: `PERCENTAGE_TIMEOUT` to a value between 0.00 - 1.00, where 0.01 is equivalent to 1%. This value represents the proportion of times a timeout error will be returned.
- Generating a delay in the JWKS response.
    - Update the environment variable: `PERCENTAGE_DELAY` to a value between 0.00 - 1.00, where 0.01 is equivalent to 1%. This value represents the proportion of times the Mock JWKS will have a delay in responding.
    - Update the environment variable: `MAXIMUM_DELAY_MILLISECONDS` to a positive number, where 1000 is equivalent to 1 second. When the Mock JWKS is responding with a delay, the length of the delay will be randomly selected between zero milliseconds and the length set by this environment variable.
