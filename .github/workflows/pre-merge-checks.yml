
name: test and build

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-ais-stub:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Install
        working-directory: ./di-ipv-ais-stub/lambdas
        run: npm ci
      - name: Build
        working-directory: ./di-ipv-ais-stub/lambdas
        run: npm run build
      - name: Test
        working-directory: ./di-ipv-ais-stub/lambdas
        run: npm run test

  test-core-stub:
    uses: ./.github/workflows/test-java-project.yml
    with:
      folder: 'di-ipv-core-stub'

  test-cimit-stub-java:
    uses: ./.github/workflows/test-java-project.yml
    with:
      folder: 'di-ipv-cimit-stub'

  test-cimit-stub-typescript:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Setup .npmrc
        working-directory: ./di-ipv-cimit-stub-ts/lambdas
        run: |
          cp .npmrc.template .npmrc && \
          sed -i s/TOKEN_WITH_READ_PACKAGE_PERMISSION/${{ secrets.GITHUB_TOKEN }}/ .npmrc
      - name: Install
        working-directory: ./di-ipv-cimit-stub-ts/lambdas
        run: npm ci
      - name: Build
        working-directory: ./di-ipv-cimit-stub-ts/lambdas
        run: npm run build
      - name: Test
        working-directory: ./di-ipv-cimit-stub-ts/lambdas
        run: npm run test

  test-cri-stub:
    uses: ./.github/workflows/test-java-project.yml
    with:
      folder: 'di-ipv-credential-issuer-stub'

  test-dcmaw-async-stub:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Install
        working-directory: ./di-ipv-dcmaw-async-stub/lambdas
        run: npm ci
      - name: Lint
        working-directory: ./di-ipv-dcmaw-async-stub/lambdas
        run: npm run check
      - name: Test
        working-directory: ./di-ipv-dcmaw-async-stub/lambdas
        run: npm run test

  test-evcs-stub:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Install
        working-directory: ./di-ipv-evcs-stub/lambdas
        run: npm ci
      - name: Build
        working-directory: ./di-ipv-evcs-stub/lambdas
        run: npm run build
      - name: Test
        working-directory: ./di-ipv-evcs-stub/lambdas
        run: npm run test

  test-experian-fraud-stub:
    uses: ./.github/workflows/test-java-project.yml
    with:
      folder: 'experian-fraud-stub'

  test-orchestrator-stub:
    uses: ./.github/workflows/test-java-project.yml
    with:
      folder: 'di-ipv-orchestrator-stub'

  test-public-jwk-creator:
    uses: ./.github/workflows/test-java-project.yml
    with:
      folder: 'public-jwk-creator'

  # di-ipv-queue-stub currently has no tests

  test-sis-stub:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Install
        working-directory: ./di-ipv-sis-stub/lambdas
        run: npm ci
      - name: Build
        working-directory: ./di-ipv-sis-stub/lambdas
        run: npm run build
      - name: Test
        working-directory: ./di-ipv-sis-stub/lambdas
        run: npm run test

  test-ticf-stub:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Install
        working-directory: ./di-ipv-ticf-stub/lambdas
        run: npm ci
      - name: Build
        working-directory: ./di-ipv-ticf-stub/lambdas
        run: npm run build
      - name: Test
        working-directory: ./di-ipv-ticf-stub/lambdas
        run: npm run test

  test-update-ecs-env-vars:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Install
        working-directory: ./update-ecs-env-vars
        run: npm ci
      - name: Test
        working-directory: ./update-ecs-env-vars
        run: npm run test
