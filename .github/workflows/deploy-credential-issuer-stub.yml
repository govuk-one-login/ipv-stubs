name: Deploy Credential Issuer Stub code to instances that need updating

on:
  push:
    branches:
      - main
    paths:
      - di-ipv-credential-issuer-stub/**
      - .github/workflows/test-java-project.yml

jobs:
  test-cri-stub:
    uses: ./.github/workflows/test-java-project.yml
    with:
      folder: 'di-ipv-credential-issuer-stub'

  decide-stubs-to-deploy:
    runs-on: ubuntu-latest
    outputs:
      deploy-all-stubs: ${{ steps.get-changed-files.outputs.shared_changed }}
      deploy-address-stub: ${{ steps.get-changed-files.outputs.address_changed }}
      deploy-bav-stub: ${{ steps.get-changed-files.outputs.bav_changed }}
      deploy-ci-stub: ${{ steps.get-changed-files.outputs.ci_changed }}
      deploy-dcmaw-stub: ${{ steps.get-changed-files.outputs.dcmaw_changed }}
      deploy-dl-stub: ${{ steps.get-changed-files.outputs.dl_changed }}
      deploy-dwp-kbv-stub: ${{ steps.get-changed-files.outputs.dwp_kbv_changed }}
      deploy-experian-kbv-stub: ${{ steps.get-changed-files.outputs.experian_kbv_changed }}
      deploy-f2f-stub: ${{ steps.get-changed-files.outputs.f2f_changed }}
      deploy-fraud-stub: ${{ steps.get-changed-files.outputs.fraud_changed }}
      deploy-nino-stub: ${{ steps.get-changed-files.outputs.nino_changed }}
      deploy-passport-stub: ${{ steps.get-changed-files.outputs.passport_changed }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0
        id: last_successful_commit_push_on_main
        with:
          main-branch-name: main

      - name: Get changed files
        id: get-changed-files
        run: |
          BASE_SHA="${{ steps.last_successful_commit_push_on_main.outputs.base }}"
          CHANGED=$(git diff --name-only "$BASE_SHA"...HEAD)

          check_changes() {
            local id="$1"
            shift
            local found="false"
            for pattern in "$@"; do
              if echo "$CHANGED" | grep -q "$pattern"; then
                found="true"
                break
              fi
            done
            echo "${id}=${found}" >> "$GITHUB_OUTPUT"
          }

          check_changes "shared_changed" \
            "^di-ipv-credential-issuer-stub/gradle/" \
            "^di-ipv-credential-issuer-stub/src/" \
            "^di-ipv-credential-issuer-stub/[^/]*$"

          check_changes "address_changed" "^di-ipv-credential-issuer-stub/deploy/address/"
          check_changes "bav_changed" "^di-ipv-credential-issuer-stub/deploy/bav/"
          check_changes "ci_changed" "^di-ipv-credential-issuer-stub/deploy/claimed-identity/"
          check_changes "dcmaw_changed" "^di-ipv-credential-issuer-stub/deploy/dcmaw/"
          check_changes "dl_changed" "^di-ipv-credential-issuer-stub/deploy/driving-licence/"
          check_changes "dwp_kbv_changed" "^di-ipv-credential-issuer-stub/deploy/dwp-kbv/"
          check_changes "experian_kbv_changed" "^di-ipv-credential-issuer-stub/deploy/experian-kbv/"
          check_changes "f2f_changed" "^di-ipv-credential-issuer-stub/deploy/face-to-face/"
          check_changes "fraud_changed" "^di-ipv-credential-issuer-stub/deploy/fraud/"
          check_changes "nino_changed" "^di-ipv-credential-issuer-stub/deploy/nino/"
          check_changes "passport_changed" "^di-ipv-credential-issuer-stub/deploy/passport/"

  deploy-address-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-address-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-address-stub.yml

  deploy-bav-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-bav-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-bav-stub.yml

  deploy-ci-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-ci-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-claimed-identity-stub.yml

  deploy-dcmaw-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-dcmaw-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-dcmaw-stub.yml

  deploy-dl-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-dl-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-driving-licence-stub.yml

  deploy-dwp-kbv-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-dwp-kbv-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-dwp-kbv-stub.yml

  deploy-experian-kbv-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-experian-kbv-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-experian-kbv-stub.yml

  deploy-f2f-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-f2f-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-f2f-stub.yml

  deploy-fraud-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-fraud-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-fraud-stub.yml

  deploy-nino-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-nino-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-nino-stub.yml

  deploy-passport-stub:
    needs:
      - test-cri-stub
      - decide-stubs-to-deploy
    if: |
      needs.test-cri-stub.result == 'success' &&
      (needs.decide-stubs-to-deploy.outputs.deploy-passport-stub == 'true' || needs.decide-stubs-to-deploy.outputs.deploy-all-stubs == 'true')
    uses: ./.github/workflows/cri-passport-stub.yml
